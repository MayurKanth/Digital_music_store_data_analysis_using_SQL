-- Who is the senior most employee based on job title ?
 SELECT *
FROM employee
ORDER BY levels DESC LIMIT 1 ;

-- which countries have the most invoices ??

SELECT billing_country AS country, COUNT(invoice_id) AS Count
FROM invoice
GROUP  BY 1
ORDER BY COUNT(invoice_id) DESC ;

-- What are top 3 values of total invoice ?

SELECT distinct(total) FROM INVOICE
ORDER BY total DESC LIMIT 3 ;

-- Which city has the best customers??
SELECT billing_city,SUM(total) AS `TOTAL INVOICE`  from invoice
GROUP BY billing_city
ORDER BY SUM(total) DESC 
LIMIT 1;

-- Who is the best customer ??

SELECT CONCAT(first_name, " ",last_name) AS Customer_name ,SUM(total) 
FROM customer C JOIN invoice I ON C.customer_id = I.customer_id 
GROUP BY 1
ORDER BY SUM(total) DESC
LIMIT 1;

-- Write a query to return the email,first name, last name, genre odf all rock music listeners. 
-- Return your list ordered alphabetically by email starting with A . 

SELECT DISTINCT(CONCAT(FIRST_NAME," ",LAST_NAME)) As _Name, email FROM CUSTOMER C JOIN invoice INV  ON C.customer_id=INV.customer_id
JOIN  invoice_line INL ON INV.invoice_id= INL.invoice_id
JOIN  track T ON INL.track_id= T.track_id
JOIN  genre G ON T.genre_id= G.genre_id
WHERE G.name LIKE "%rock%"
ORDER BY email 
;

SELECT * FROM ARTIST;
SELECT * FROM ALBUMS;

-- lets invite the artists who have written the most rock music in our dataset. 
-- Write a query that returns the artist name and total track count of the top 10 rock bands. 
SELECT artist.Artist_id,artist.name, COUNT(artist.artist_ID) FROM Artist 
JOIN Albums ON Artist.artist_id = Albums.artist_id 
JOIN track ON albums.album_id = track.album_id 
JOIN genre ON track.genre_id = genre.genre_id
WHERE genre.Name like "ROCK" 
GROUP BY artist_id,artist.name
ORDER BY COUNT(artist.Artist_ID) DESC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 ;

-- Return all the track names that have a song length longer than the average song length.
-- Return the name and milliseconds for each track. Order by the song length with the longest songs listed first.
SELECT Name, milliseconds from track
where milliseconds > (SELECT avg(milliseconds) from track)
ORDER BY milliseconds DESC ;

-- find how much amount spent by each customer on artists ? Write a query to return customer name,artist nameand total spent. 
Select CONCAT(first_name," ", last_name) AS CUSTOMER ,artist.name AS `Artist Name`,
SUM(invoice_line.unit_price * invoice_line.quantity )
FROM CUSTOMER
JOIN INVOICE ON CUSTOMER.CUSTOMER_ID = INVOICE.CUSTOMER_ID
JOIN INVOICE_LINE ON INVOICE.INVOICE_ID=INVOICE_LINE.INVOICE_ID
JOIN TRACK ON INVOICE_LINE.TRACK_ID = TRACK.TRACK_ID
JOIN ALBUMS ON TRACK.ALBUM_ID = ALBUMS.ALBUM_ID
JOIN ARTIST ON ALBUMS.ARTIST_ID=ARTIST.ARTIST_ID
GROUP BY 1,2
ORDER BY 3 DESC;

-- We want to find out the most popular music genre for each country.
SELECT * FROM (SELECT Billing_country,
       genre.name,
       COUNT(invoice_line.quantity) AS quantity_count,
       DENSE_RANK() OVER (PARTITION BY Billing_country ORDER BY COUNT(invoice_line.quantity) DESC) AS _rank
FROM invoice
JOIN invoice_line ON invoice.invoice_id = invoice_line.invoice_id
JOIN track ON invoice_line.track_id = track.track_id
JOIN genre ON track.genre_id = genre.genre_id
GROUP BY Billing_country, genre.name
ORDER BY 1) T1  
WHERE _rank =1 ;


-- write a query that determines the customer that has spent the most on music for each country. 
-- write a query that returns the country along with the top customer and how much they spend
-- For countries where the top amount is shared , provide all the cusomers who spent this amount. 

SELECT * FROM 
(SELECT country,CONCAT(first_name," ",LAST_NAME) AS CUSTOMER_NAME,ROUND(SUM(total),2) As Amount_Spend,
DENSE_RANK() OVER (PARTITION BY COUNTRY ORDER BY SUM(TOTAL) DESC) AS RANKING
FROM invoice
JOIN customer ON invoice.customer_id = customer.customer_id
group by 1,2
order by 1 ) T1
WHERE RANKING = 1;
